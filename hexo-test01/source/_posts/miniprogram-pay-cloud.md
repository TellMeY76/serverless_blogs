---
title: 小程序利用云开发实现微信支付的实践
tags: [小程序]
categories: learning
toc: true
mathjax: true
---
利用云开发中的云函数实现小程序的微信支付
<!-- more -->

### 当前的问题：

* 在微信小程序的开发中，微信支付是让前后端都比较头大的一环，后端的同学相对来说压力大一点，而由于后端的同学需要时间进行各种数据的加解密，

前端很多时候只能等着接口干着急。随着微信云开发的更新，一种新的解决方案出现了。

### 船新的解决方案：

* 在云开发更新之后的文档中，我们可以看到这么一段话：

 > 从开发者工具 1.02.2005111 起，云控制台支持云开发微信支付商户绑定，在绑定完成后可在云开发中原生接入微信支付：
 > 1、免签名：所有接口免签名、直接获取小程序 wx.requestPayment 所需参数；
 > 2、接收回调：云函数支持接收异步支付结果回调 

* 这就意味着，后端的同学可能可以从复杂的加解密过程中解放出来了，前端的同学也可以开始自己动手，丰衣足食了。

* 到底是不是这么好用呢，跟着文档来试试吧。

### 实践一下：

* 首先根据文档的提示，先完成对开发者工具的设置，[具体看这里](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/wechatpay.html)

* 相关的API：

  + CloudPay.closeOrder()
   关闭订单

  + CloudPay.downloadBill()
   下载对账单

  + CloudPay.queryOrder()
   查询订单

  + CloudPay.queryRefund()
  查询退款

  + CloudPay.refund()
  申请退款

  + CloudPay.unifiedOrder()
  统一下单

* 开发的主要流程：
  1. 小程序调用云函数，在云函数中调用统一下单接口，参数中带上接收异步支付结果的云函数名和其所在云环境 ID
  2. 统一下单接口返回的成功结果对象中有 payment 字段，该字段即是小程序端发起支付的接口（wx.requestPayment）所需的所有信息
  3. 小程序端拿到云函数结果，调用 wx.requestPayemnt 发起支付
  4. 支付完成后，在统一下单接口中配置的云函数将收到支付结果通知 

* 支付回调：

  + 微信支付云调用在调用时，需要传递 envId 和 functionName 这两个参数，这两个参数将会在微信支付成功后，发送相应的消息通知，来告知开发者用户的支付状态。

### 小结：

通过云开发的方式实现微信支付，可以极大程度的减轻了前后端的工作量，虽然可能会存在一些问题（比如兼容性？），但我觉得还是很值得在实际场景中去使用的。

### one more thing:
可能我的文字的描述过于简单，附上b站上大佬的教学视频，[传送门](https://www.bilibili.com/video/BV1Tz4y1d7CX)
